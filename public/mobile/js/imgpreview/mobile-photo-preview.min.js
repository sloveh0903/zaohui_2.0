/*! mobile-photo-preview  v1.0.0
* author:tianxiangbing email:55342775@qq.com
* demo:http://www.lovewebgames.com/jsmodule/mobile-photo-preview.html 
* git:https://github.com/tianxiangbing/mobile-photo-preview  2016-01-06 */
!function(a,b){"function"==typeof define&&define.amd?define(["$","dialog"],b):"object"==typeof exports?module.exports=b():a.MobilePhotoPreview=b($,Dialog)}(this,function(a,b){function c(){var a=Math.random().toString().replace(".","");this.id="mp_"+a,this.currentIndex=1,this.sum=1,this.arr=[],this.objArr={},this.dialog,this.bloom=!0}return a.fn.MobilePhotoPreview=function(b){a(this).each(function(){var d=new c;d.init(a.extend({target:a(this)},b))})},c.prototype={init:function(b){this.settings=a.extend({animate:!0},b),this.target=a(this.settings.target),this.trigger=this.settings.trigger||"a",this.bloom=this.settings.bloom,this.bindEvent()},touch:function(b,c,d){function e(a){return d.call(this,a)}var f;"function"==typeof c&&(d=c),a(b).on("touchmove",c,function(){f=!0}).on("touchend",c,function(a){if(a.preventDefault(),!f){var b=d.call(this,a,"touch");b===!1&&(a.preventDefault(),a.stopPropagation())}f=!1}),a(b).on("click",c,e)},bindEvent:function(){var a=this;a.touch(a.target,a.trigger,function(){return a.initDailog.call(a,this),!1})},bindSlide:function(){var b=this,c={},d=0,e={},f=!1,g={};b.imgPreview.on("touchstart",function(b){var e=b.changedTouches||b.originalEvent.changedTouches;return c={x:e[0].pageX,y:e[0].pageY},2==e.length?(f=!1,!1):(g=a(this).position(),void(d=event.pageX))}),b.imgPreview.on("touchmove",function(d){var h=d.changedTouches||d.originalEvent.changedTouches;return 2==h.length?!1:(f=!0,e={x:h[0].pageX,y:h[0].pageY},b.bloom?(g={left:g.left+(e.x-c.x),top:g.top+(e.y-c.y)},a(this).css(g)):(g.left=g.left+(e.x-c.x),a(this).css({left:g.left})),c=e,!1)}),b.imgPreview.on("touchend",function(g){var h=g.changedTouches||g.originalEvent.changedTouches;if(e={x:h[0].pageX,y:h[0].pageY},2==h.length)return c=e,!1;var i=a(this).position(),j={left:i.left+(e.x-c.x),top:i.top+(e.y-c.y)};a(this).css(j);var k=Math.abs(j.left/b.maxWidth),l=k.toString().split("."),m=0,n=l.length>1?"0."+l[1]:0;m=n>.3?Math.ceil(k):Math.floor(k),b.currentIndex=m,d<e.x&&b.currentIndex--,b.currentIndex<0&&(b.currentIndex=0),b.currentIndex>=b.arr.length&&(b.currentIndex=b.arr.length-1),b.go(b.settings.animate),f=!1})},go:function(b){var c=this,d=c.currentIndex*c.maxWidth;b=b?"animate":"css",a(c.imgPreview)[b]({left:-d,top:0},200);var e=c.dialog.dialogContainer;a(".imgViewTop em",e).html(c.currentIndex+1+"/"+c.arr.length),c.current=a(c.arr[c.currentIndex]),c.settings.callback&&c.settings.callback.call(c,c.objArr[c.currentIndex],c.currentIndex)},initDailog:function(c){var d=this;d.dialog=null,d.dialog=new b,d.arr=d.target.find(d.trigger),d.sum=d.arr.length,d.currentIndex=a(c).index();var e=document.documentElement.clientHeight||document.body.clientHeight,f=document.documentElement.clientWidth||document.body.clientWidth,g=a.extend({target:'<div class="imgViewTop"><em>'+(d.currentIndex+1)+"/"+d.sum+'</em></div><div class="pos-relative"><div id="imgPreview"></div></div><div id="imgTitle"></div>',animate:!0,show:!0,width:f,height:e,mask:!0,className:"ui-preview",afterHide:function(){this.dispose(),d.settings.hide&&d.settings.hide()},beforeHide:function(){var b=d.imgPreview.children()[d.currentIndex];a(b).siblings().hide()},beforeShow:function(b){var c=this;d.imgPreview=a("#imgPreview",b),d.format(b),d.bindSlide(),d.go(!1),d.settings.show&&d.settings.show.call(d,d.dialog.dialogContainer),d.imgPreview.on("click",function(){c.dispose()})}},{});d.dialog.init(g)},hide:function(){this.dialog.hide()},format:function(){function b(b){c.length++;var d=a(c.imgPreview.children().get(b)),e=a(this),f=e[0].height,g=e[0].width;d.html(e),d.css("background","transparent"),c.objArr[b]={src:this.src,height:f,width:g,elem:e,index:b},c.objArr.length=c.length,c.initSize(b)}var c=this;this.length=0;for(var d="",e=0,f=c.arr.length;f>e;e++){var g=a(c.arr[e]),h='style="visibility:hidden;"';e==c.currentIndex&&(h='style="display:block;"');var i=g.attr("href")||g.find("input").val()||g.find("img").attr("src")||g.attr("src");d+="<div "+h+"></div>",function(a,c,d){setTimeout(function(){var a=new Image;a.src=d,a.complete?b.call(a,c):(a.onreadystatechange=function(){("complete"==this.readystate||"loaded"==this.readyState)&&b.call(this,c)},a.onload=function(){b.call(this,c)})},100)}(g,e,i)}c.imgPreview.html(d),setTimeout(function(){c.imgPreview.children().css("visibility","visible")},500),c.setSize(),a(window).resize(a.proxy(c.setSize,c))},setSize:function(){var b=this,c=b.dialog.dialogContainer,d=document.documentElement.clientHeight||document.body.clientHeight,e=document.documentElement.clientWidth||document.body.clientWidth;this.maxHeight=d-a(".imgViewTop",c).height()-a(".imgTitle",c).height(),this.maxWidth=e,b.imgPreview.width(this.maxWidth*b.arr.length),b.imgPreview.height(this.maxHeight),b.imgPreview.children("div").width(this.maxWidth)},initSize:function(a){var b=this.objArr[a];if(this.maxHeight<b.height){b.elem.height(this.maxHeight);var c=this.maxHeight*b.width/b.height;b.elem.width(c),b.height=this.maxHeight,b.width=c}if(this.maxWidth<b.width){b.elem.width(this.maxWidth);var d=this.maxWidth*b.height/b.width;b.elem.height(d),b.height=d,b.width=this.maxWidth}var e=(this.maxHeight-b.height)/2,f=(this.maxWidth-b.width)/2;b.elem.css({top:e,left:f})}},c});